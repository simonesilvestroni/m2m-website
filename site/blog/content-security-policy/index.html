<!DOCTYPE html>
<html lang="en-GB" dir="ltr" itemscope itemtype="http://schema.org/WebPage">
<head>
	<title>Minutes to Midnight - Content security policy on Netlify</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="robots" content="noindex, nofollow, noai, noimageai">
	<!-- minimal open graph implementation -->
	<meta content="Content security policy on Netlify" property="og:title">
	<meta content="How I implemented a content security policy on a static website built with Jekyll, hosted on Netlify and loaded with several external embeds." name="description" property="og:description">
	<meta content="/assets/images/m2m-og-image.png" property="og:image">
	<meta content="/assets/images/m2m-og-image.png" name="twitter:card">
	<!-- end open graph -->
	<meta name="pinterest" content="nopin">
	<link rel="preload" href="https://minutestomidnight.co.uk/assets/fonts/rubik-regular.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="stylesheet" href="https://minutestomidnight.co.uk/assets/css/m2m.css">
	<link rel="icon" href="https://minutestomidnight.co.uk/favicon.ico" sizes="any">
	<link rel="icon" href="https://minutestomidnight.co.uk/assets/images/favicons/favicon.svg" type="image/svg+xml">
	<link rel="apple-touch-icon" href="https://minutestomidnight.co.uk/assets/images/favicons/apple-touch-icon.png" sizes="180x180">
	<link rel="manifest" href="https://minutestomidnight.co.uk/assets/images/favicons/site.webmanifest">
	<link rel="preview" href="https://minutestomidnight.co.uk/assets/images/m2m-og-image.png">
	<link rel="canonical" href="https://minutestomidnight.co.uk/blog/content-security-policy/">
	<script type="application/ld+json">
	{
		"@context": "http://schema.org",
		"@type": "WebSite",
		"name": "Minutes to Midnight",
		"headline": "Web designer & music producer",
		"url": "https://minutestomidnight.co.uk/blog/content-security-policy/",
		"description": "How I implemented a content security policy on a static website built with Jekyll, hosted on Netlify and loaded with several external embeds.",
		"keywords": "minutes to midnight, simone silvestroni, sound design, bass, game audio, foley, field recording, music production, music composer, mix, master, reaper, pro tools, logic pro, web design, web development, web performance, web accessibility, web usability, front-end, ux, user experience, jekyll, wordpress, html, css",
		"datePublished": "2022-03-30 00:00:00 +0100",
		"dateModified": "2024-09-28T12:26:47+01:00",
		"author": {
			"@type": "Person",
			"name": "Simone Silvestroni",
			"givenName": "Simone",
			"familyName": "Silvestroni"
		},
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": "https://minutestomidnight.co.uk/blog/content-security-policy/"
		},
		"image": {
			"@type": "ImageObject",
			"width": "500",
			"height": "500",
			"url": "https://minutestomidnight.co.uk/assets/images/m2m-og-image.png"
		},
		"sameAs": [
			"https://github.com/simonesilvestroni",
			"https://www.linkedin.com/in/simonesilvestroni",
			"https://minutestomidnight.bandcamp.com",
			"https://www.youtube.com/@m2m"
		]
	}
	</script>
</head>
<body id="top" class="post content-security-policy">
	<div class="skip-links">
		<a href="#main">Skip to content</a>
		<a href="#footer">Skip to footer</a>
	</div>
	<header>
		<a href="https://minutestomidnight.co.uk"><img src="https://minutestomidnight.co.uk/assets/images/m2m-nav-logo.svg" alt="Back to the homepage" width="32" height="32"></a>
		<nav aria-label="Main navigation">
			<ul>
				<li><a href="/about/">About</a></li><li><a class="current" href="/blog/">Blog</a></li><li><a href="/contact/">Contact</a></li><li><a href="/feed.xml"><img class="logo-rss" src="/assets/images/rss.svg" alt="RSS" width="20" height="20"></a></li>
			</ul>
		</nav>
	</header>
	<main id="main">
	<article class="h-entry">
	<header>
		<h1>Content security policy on Netlify</h1>
	</header>
	
	<p class="highlight"><span>How I implemented a content security policy on a static website built with Jekyll, hosted on Netlify and loaded with several external embeds.</span></p>
	
	<div class="author">
		<a href="https://minutestomidnight.co.uk/about/"><img src="https://minutestomidnight.co.uk/assets/images/minutes-to-midnight-portrait.jpg" alt="Simone Silvestroni" width="48" height="48"></a>&nbsp;&nbsp;<a href="https://minutestomidnight.co.uk/blog/content-security-policy/" title="Permalink"><time datetime="2022-03-30T00:00:00+01:00" itemprop="dateCreated">30 Mar 2022</time></a>
	</div>
	<h2 id="what-is-a-content-security-policy">What is a content security policy?</h2>

<blockquote>
  <p>Content Security Policy (CSP) is an added layer of security that helps to detect and mitigate certain types of attacks, including Cross-Site Scripting (XSS) and data injection attacks. These attacks are used for everything from data theft, to site defacement, to malware distribution.<cite>Mozilla Developer Network</cite></p>
</blockquote>

<p>Although using a static web site usually means you have to worry less about security, the <a href="https://blog.sqreen.com/static-websites-security/">big picture is a bit more complicated</a>. I embed many <code>&lt;iframe&gt;</code> elements due to necessity. Bandcamp, Soundcloud, Spotify and YouTube, to name them all. Some of these embeds are generating awful code and tens of third-party scripts. I could have <a href="https://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/">sandboxed the iframes</a>, but I wanted a more tight way to protect the entire website. Enter content security policy (CSP).</p>

<h2 id="implementing-csp-on-netlify">Implementing CSP on Netlify</h2>

<p>In the past, using WordPress, I had to work on the Apache configuration to configure a web server to return the Content-Security-Policy HTTP header. The <code>&lt;meta&gt;</code> element can be used to configure a policy. For example:</p>

<pre><code class="language-html">&lt;meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';"&gt;
</code></pre>

<p>After the switch to Jekyll and Netlify the process is significantly simplified. I just created a specific <code>netlify.toml</code> configuration file in my repository and added the instructions. The tricky part was to find out all the external resources I'm pinging, including those I wasn't fully aware of. For example, webmentions are implemented through a Javascript calling <code>https://webmention.io</code>, which pulls in all the mentions including avatar images. For this specific case, in the <code>Content-Security-Policy</code> section I had to allow:</p>

<pre><code>img-src 'self' https://webmention.io https://*.amazonaws.com;
</code></pre>

<p>The main difficulty about the aforementioned audio-visual embeds was connected to their habit of injecting inline CSS, which I decided to disallow. The fix came from forcing their iframes to print specific classes based on my inclusion method in Jekyll, and move the third-party inline CSS to my SASS theme.</p>

<h3 id="bandcamp">Bandcamp</h3>

<p>Bandcamp comes with a fixed dimension <code>iframe</code>, depending on a few options when choosing the embed code on their site. Once I'd decided to always use the small version of the album picture, the main difference is the object height. I have three cases:</p>

<ul>
  <li>Single song</li>
  <li>2-song EP</li>
  <li>Album</li>
</ul>

<p>I turned their fixed height into specific embed classes: <code>'bc-single'</code>, <code>'bc-ep'</code>, and <code>'bc-album'</code>. Note that in Bandcamp, whenever I have more than one song, I always check "Show tracklist":</p>

<p><img src="/assets/images/bandcamp-embed-tracks.jpg" alt="Embed options in Bandcamp" width="960" height="630">
<em>Embed options in Bandcamp</em></p>

<h2 id="the-code">The code</h2>

<p>Here is my security policy, which grants an <a href="https://securityheaders.com/?q=minutestomidnight.co.uk&amp;followRedirects=on"><code>A+</code> on benchmarks</a>. As you can see, I don't allow CSS and Javascript, either external or inline, from external sources. I'm also blocking the website, through <code>x-frame-options</code>, from being embedded in an <code>iframe</code>.</p>

<pre><code class="language-toml">[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "deny"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "no-referrer"
    Strict-Transport-Security = '''
      max-age=31536000;
      includeSubDomains;
      preload
    '''
    Content-Security-Policy = '''
      default-src 'self' https://webmention.io;
      style-src 'self';
      img-src 'self' https://webmention.io https://*.amazonaws.com;
      script-src 'self';
      frame-src https://yewtu.be/embed/ https://www.youtube-nocookie.com/embed/ https://bandcamp.com/EmbeddedPlayer/
    '''
    Permissions-Policy = '''
      accelerometer=(none),
      ambient-light-sensor=(none),
      autoplay=(none),
      camera=(none),
      encrypted-media=(none),
      fullscreen=(none),
      geolocation=(none),
      gyroscope=(none),
      magnetometer=(none),
      microphone=(none),
      midi=(none),
      payment=(none),
      picture-in-picture=(none),
      speaker=(none),
      usb=(none),
      vibrate=(none),
      vr=(none)
    '''
</code></pre>

<p>Read more:</p>

<ul>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Mozilla developer network</a></li>
  <li><a href="https://content-security-policy.com/">Content Security Policy Reference</a> (includes a browser test)</li>
</ul>

	<footer>
		<p>Comments? <a href="mailto:hello@minutestomidnight.co.uk?subject=Content%20security%20policy%20on%20Netlify" title="Reply to this post">Reply via email</a>.</p>
		<ul class="taxonomy">
			<li><a href="/blog/tag/internet/"><span>INTERNET</span></a>
			<li><a href="/blog/tag/web-development/"><span>WEB DEVELOPMENT</span></a></li>
		</ul>
	</footer>
</article>
<div class="pagination">
	<a class="pagination-prev" href="https://minutestomidnight.co.uk/blog/life-after-social-networks/">
		<span>&larr;&nbsp;Older</span>
		<span>Life after social networks</span>
	</a><a class="pagination-next" href="https://minutestomidnight.co.uk/blog/implementing-webp-images-in-jekyll/">
		<span>Newer&nbsp;&rarr;</span>
		<span>Implementing WebP images in Jekyll</span>
	</a>
</div>
	</main>
	<footer id="footer">
		<nav aria-label="Secondary navigation">
			<ul>
				<li><a href="https://minutestomidnight.co.uk/sound-design/#original-music">My music</a></li>
				<li><a href="https://minutestomidnight.co.uk/now/">Now</a></li>
				<li><a href="https://minutestomidnight.co.uk/blogroll/">Blogroll</a></li>
				<li><a href="https://minutestomidnight.co.uk/sitemap/">Sitemap</a></li>
				<li><a href="https://minutestomidnight.co.uk/search/">Search</a></li>
				</ul>
		</nav>
		<p><a href="https://minutestomidnight.co.uk/colophon/#copyright">&copy; 2024 + CC BY 4.0</a></p>
		<p>Handcrafted using Jekyll 4.3.3, Liquid, and the M2M CSS framework. Typefaces: <em>Rubik, with a touch of serif</em>. Info about <a href="https://minutestomidnight.co.uk/colophon/#about-the-website">the website</a>, <a href="https://minutestomidnight.co.uk/colophon/#accessibility-and-sustainability">accessibility &amp; sustainability</a>, and <a href="https://minutestomidnight.co.uk/colophon/#privacy">privacy</a>.</p>
		<hr>
		<nav aria-label="Footer navigation">
			<ul>
				<li><a href="https://themarkup.org/blacklight?location=eu&device=desktop&force=false&url=minutestomidnight.co.uk">No tracking</a></li>
				<li><a href="#top">&uarr;&nbsp;Back to top</a></li>
			</ul>
		</nav>
	</footer>
</body>
</html>